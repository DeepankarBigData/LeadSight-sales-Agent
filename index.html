<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>NEXUS ‚Äî Sales Intelligence Agent</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:ital,wght@0,300;0,400;1,300&display=swap" rel="stylesheet" />
<style>
  :root {
    --bg: #04060f;
    --surface: #0a0d1a;
    --card: #0f1424;
    --border: rgba(99,179,255,0.12);
    --accent: #3b82f6;
    --accent2: #06d6a0;
    --accent3: #f72585;
    --text: #e8eeff;
    --muted: #6b7a99;
    --glow: rgba(59,130,246,0.25);

    /* ‚ö†Ô∏è UPDATE this if your server runs on a different host/port */
    --api-base: http://localhost:5000;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Mono', monospace;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(59,130,246,0.04) 1px, transparent 1px),
      linear-gradient(90deg, rgba(59,130,246,0.04) 1px, transparent 1px);
    background-size: 48px 48px;
    pointer-events: none; z-index: 0;
  }

  .orb {
    position: fixed; width: 600px; height: 600px; border-radius: 50%;
    background: radial-gradient(circle, rgba(59,130,246,0.15) 0%, transparent 70%);
    top: -200px; right: -200px; pointer-events: none; z-index: 0;
    animation: orbFloat 8s ease-in-out infinite;
  }
  .orb2 {
    width: 400px; height: 400px;
    background: radial-gradient(circle, rgba(6,214,160,0.1) 0%, transparent 70%);
    top: auto; bottom: -150px; left: -100px; animation-delay: -4s;
  }
  @keyframes orbFloat {
    0%, 100% { transform: translate(0,0) scale(1); }
    50% { transform: translate(-30px,30px) scale(1.05); }
  }

  .wrapper { position: relative; z-index: 1; max-width: 1100px; margin: 0 auto; padding: 0 24px 80px; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    padding: 32px 0 0;
    display: flex; align-items: center; justify-content: space-between;
  }
  .logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 1.5rem; letter-spacing: -0.03em; }
  .logo span { color: var(--accent); }
  .badge {
    font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase;
    background: rgba(59,130,246,0.15); color: var(--accent);
    border: 1px solid rgba(59,130,246,0.3); padding: 4px 12px; border-radius: 100px;
  }

  /* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
  .hero { padding: 64px 0 48px; text-align: center; }
  .hero-label {
    display: inline-block; font-size: 0.7rem; letter-spacing: 0.2em;
    text-transform: uppercase; color: var(--accent2); margin-bottom: 20px;
  }
  h1 {
    font-family: 'Syne', sans-serif; font-size: clamp(2.4rem, 5vw, 4rem);
    font-weight: 800; line-height: 1.05; letter-spacing: -0.04em; margin-bottom: 16px;
  }
  h1 .hl {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  .hero-sub { color: var(--muted); font-size: 0.875rem; line-height: 1.7; max-width: 560px; margin: 0 auto; }

  /* ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ */
  .upload-zone {
    border: 2px dashed rgba(59,130,246,0.3); border-radius: 20px;
    padding: 56px 32px; text-align: center; background: var(--card);
    cursor: pointer; transition: all 0.3s ease; position: relative; overflow: hidden;
  }
  .upload-zone::before {
    content: ''; position: absolute; inset: 0;
    background: radial-gradient(circle at 50% 50%, rgba(59,130,246,0.05), transparent 70%);
    opacity: 0; transition: opacity 0.3s;
  }
  .upload-zone:hover, .upload-zone.dragover {
    border-color: var(--accent); background: rgba(59,130,246,0.05);
    transform: translateY(-2px); box-shadow: 0 0 40px var(--glow), 0 8px 32px rgba(0,0,0,0.4);
  }
  .upload-zone:hover::before, .upload-zone.dragover::before { opacity: 1; }

  .upload-icon {
    width: 64px; height: 64px; margin: 0 auto 20px;
    background: rgba(59,130,246,0.12); border: 1px solid rgba(59,130,246,0.25);
    border-radius: 16px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem;
  }
  .upload-title { font-family: 'Syne', sans-serif; font-size: 1.2rem; font-weight: 700; margin-bottom: 8px; }
  .upload-sub { font-size: 0.75rem; color: var(--muted); margin-bottom: 24px; }
  .upload-types { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
  .type-tag {
    font-size: 0.65rem; letter-spacing: 0.1em; text-transform: uppercase;
    background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
    color: var(--muted); padding: 4px 10px; border-radius: 6px;
  }
  input[type="file"] { display: none; }

  /* File preview strip */
  .file-preview {
    display: none; align-items: center; gap: 12px;
    background: rgba(6,214,160,0.08); border: 1px solid rgba(6,214,160,0.25);
    border-radius: 12px; padding: 14px 20px; margin-top: 16px;
  }
  .file-preview.show { display: flex; }
  .file-name { font-size: 0.8rem; color: var(--accent2); flex: 1; }
  .file-size { font-size: 0.7rem; color: var(--muted); }
  .file-remove { background: none; border: none; color: var(--muted); cursor: pointer; font-size: 1rem; padding: 4px; border-radius: 4px; transition: color 0.2s; }
  .file-remove:hover { color: var(--accent3); }

  /* Schema hint */
  .schema-hint {
    font-size: 0.7rem; color: var(--muted); text-align: center;
    margin-top: 12px; line-height: 1.6;
  }
  .schema-hint code {
    background: rgba(255,255,255,0.06); padding: 2px 6px; border-radius: 4px;
    color: var(--accent2); font-size: 0.68rem;
  }

  /* Run button */
  .run-btn {
    width: 100%; padding: 18px 32px; margin-top: 20px;
    background: linear-gradient(135deg, var(--accent), #2563eb);
    border: none; border-radius: 14px; color: #fff;
    font-family: 'Syne', sans-serif; font-size: 1rem; font-weight: 700;
    letter-spacing: 0.05em; cursor: pointer; position: relative; overflow: hidden;
    transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px;
  }
  .run-btn::before {
    content: ''; position: absolute; top: 0; left: -100%;
    width: 100%; height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent);
    transition: left 0.5s;
  }
  .run-btn:hover::before { left: 100%; }
  .run-btn:hover { transform: translateY(-2px); box-shadow: 0 12px 40px rgba(59,130,246,0.4); }
  .run-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }

  /* ‚îÄ‚îÄ PROGRESS ‚îÄ‚îÄ */
  .progress-section { display: none; background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 28px; margin-bottom: 32px; }
  .progress-section.show { display: block; }
  .progress-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
  .progress-title { font-family: 'Syne', sans-serif; font-size: 0.9rem; font-weight: 700; }
  .progress-pct { font-size: 0.75rem; color: var(--accent); font-weight: 600; }
  .progress-bar-bg { background: rgba(255,255,255,0.05); border-radius: 100px; height: 6px; overflow: hidden; margin-bottom: 24px; }
  .progress-bar-fill {
    height: 100%; background: linear-gradient(90deg, var(--accent), var(--accent2));
    border-radius: 100px; width: 0%; transition: width 0.5s ease;
    box-shadow: 0 0 12px rgba(59,130,246,0.5);
  }

  /* Company progress cards */
  .company-cards { display: flex; flex-direction: column; gap: 8px; max-height: 320px; overflow-y: auto; padding-right: 4px; }
  .company-cards::-webkit-scrollbar { width: 4px; }
  .company-cards::-webkit-scrollbar-track { background: transparent; }
  .company-cards::-webkit-scrollbar-thumb { background: rgba(59,130,246,0.2); border-radius: 4px; }

  .cc {
    display: flex; align-items: center; gap: 12px;
    padding: 10px 14px; border-radius: 10px;
    background: rgba(255,255,255,0.02); border: 1px solid transparent;
    font-size: 0.75rem; transition: all 0.3s;
  }
  .cc.active { background: rgba(59,130,246,0.08); border-color: rgba(59,130,246,0.2); }
  .cc.done { background: rgba(6,214,160,0.06); border-color: rgba(6,214,160,0.15); }
  .cc.error { background: rgba(247,37,133,0.06); border-color: rgba(247,37,133,0.15); }

  .cc-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; background: rgba(255,255,255,0.1); }
  .cc.active .cc-dot { background: var(--accent); box-shadow: 0 0 8px var(--accent); animation: pulse 1.5s infinite; }
  .cc.done .cc-dot { background: var(--accent2); }
  .cc.error .cc-dot { background: var(--accent3); }

  .cc-name { flex: 1; font-weight: 500; }
  .cc-step { color: var(--muted); font-size: 0.68rem; font-style: italic; max-width: 380px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .cc-status { font-size: 0.65rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--muted); }
  .cc.done .cc-status { color: var(--accent2); }
  .cc.active .cc-status { color: var(--accent); }

  @keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.4); opacity: 0.7; }
  }

  /* ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ */
  .results-section { display: none; }
  .results-section.show { display: block; }

  .results-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 24px; }
  .results-title { font-family: 'Syne', sans-serif; font-size: 1.4rem; font-weight: 800; }

  /* Stats */
  .stat-strip {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 1px; background: var(--border); border: 1px solid var(--border);
    border-radius: 16px; overflow: hidden; margin-bottom: 24px;
  }
  .stat-cell { background: var(--card); padding: 18px 20px; text-align: center; }
  .stat-num {
    font-family: 'Syne', sans-serif; font-size: 1.6rem; font-weight: 800;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
  }
  .stat-lbl { font-size: 0.62rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-top: 4px; }

  /* Results table */
  .table-wrap {
    background: var(--card); border: 1px solid var(--border); border-radius: 16px; overflow: hidden; margin-bottom: 24px;
  }
  .table-header {
    padding: 16px 20px; border-bottom: 1px solid var(--border);
    display: flex; align-items: center; gap: 10px;
  }
  .table-live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent2); box-shadow: 0 0 6px var(--accent2); }
  .table-title { font-family: 'Syne', sans-serif; font-size: 0.85rem; font-weight: 700; }
  .table-count { font-size: 0.7rem; color: var(--muted); margin-left: auto; }

  .data-table { width: 100%; border-collapse: collapse; }
  .data-table th {
    padding: 10px 16px; text-align: left; font-size: 0.62rem; letter-spacing: 0.12em;
    text-transform: uppercase; color: var(--muted); border-bottom: 1px solid var(--border);
    background: rgba(255,255,255,0.02); white-space: nowrap;
  }
  .data-table td {
    padding: 12px 16px; font-size: 0.75rem; color: var(--text);
    border-bottom: 1px solid rgba(255,255,255,0.04); vertical-align: top;
    max-width: 240px; word-break: break-word;
  }
  .data-table tr:last-child td { border-bottom: none; }
  .data-table tr:hover td { background: rgba(59,130,246,0.04); }

  .td-company { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 0.8rem; }
  .td-link { color: var(--accent); text-decoration: none; font-size: 0.7rem; }
  .td-link:hover { text-decoration: underline; }
  .td-null { color: var(--muted); font-style: italic; font-size: 0.7rem; }
  .td-email { color: var(--accent2); font-size: 0.72rem; }
  .td-founded { color: var(--accent3); font-size: 0.72rem; }
  .status-badge {
    display: inline-block; font-size: 0.6rem; letter-spacing: 0.08em; text-transform: uppercase;
    padding: 2px 8px; border-radius: 100px;
  }
  .status-ok { background: rgba(6,214,160,0.1); border: 1px solid rgba(6,214,160,0.2); color: #5eead4; }
  .status-partial { background: rgba(247,191,36,0.1); border: 1px solid rgba(247,191,36,0.2); color: #fbbf24; }
  .status-empty { background: rgba(247,37,133,0.08); border: 1px solid rgba(247,37,133,0.15); color: #f9a8d4; }

  /* Download bar */
  .download-bar {
    display: flex; align-items: center; justify-content: space-between;
    background: linear-gradient(135deg, rgba(6,214,160,0.08), rgba(59,130,246,0.08));
    border: 1px solid rgba(6,214,160,0.25); border-radius: 16px; padding: 20px 24px;
  }
  .download-label { font-size: 0.65rem; letter-spacing: 0.15em; text-transform: uppercase; color: var(--accent2); margin-bottom: 4px; }
  .download-name { font-family: 'Syne', sans-serif; font-size: 0.95rem; font-weight: 700; }
  .download-meta { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }
  .download-btn {
    display: flex; align-items: center; gap: 8px;
    padding: 12px 24px; background: linear-gradient(135deg, var(--accent2), #05b88a);
    border: none; border-radius: 10px; color: #04060f;
    font-family: 'Syne', sans-serif; font-size: 0.85rem; font-weight: 700;
    cursor: pointer; transition: all 0.3s; flex-shrink: 0; text-decoration: none;
  }
  .download-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(6,214,160,0.35); }
  .download-btn:disabled { opacity: 0.5; pointer-events: none; }

  /* Error banner */
  .error-banner {
    display: none; background: rgba(247,37,133,0.08); border: 1px solid rgba(247,37,133,0.25);
    border-radius: 12px; padding: 16px 20px; margin-bottom: 20px; font-size: 0.8rem;
    color: #f9a8d4;
  }
  .error-banner.show { display: block; }

  .spinner {
    display: inline-block; width: 16px; height: 16px;
    border: 2px solid rgba(255,255,255,0.2); border-top-color: #fff;
    border-radius: 50%; animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  @media (max-width: 600px) {
    .stat-strip { grid-template-columns: repeat(2,1fr); }
    .download-bar { flex-direction: column; gap: 16px; align-items: flex-start; }
    .download-btn { width: 100%; justify-content: center; }
    .table-wrap { overflow-x: auto; }
  }
</style>
</head>
<body>

<div class="orb"></div>
<div class="orb orb2"></div>

<div class="wrapper">

  <!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
  <header>
    <div class="logo">NEX<span>US</span></div>
    <div class="badge">Sales Intelligence Agent</div>
  </header>

  <!-- ‚îÄ‚îÄ HERO ‚îÄ‚îÄ -->
  <div class="hero">
    <div class="hero-label">// Playwright ¬∑ AI Extraction ¬∑ Real-time</div>
    <h1>Company Intelligence<br/><span class="hl">From Spreadsheet to Insights</span></h1>
    <p class="hero-sub">Upload your company list, watch the agent crawl each website in real-time, extract key intelligence, and download a clean Excel report.</p>
  </div>

  <!-- ‚îÄ‚îÄ UPLOAD ‚îÄ‚îÄ -->
  <div style="margin-bottom: 40px;">

    <div class="upload-zone" id="dropZone">
      <div class="upload-icon">üìÇ</div>
      <div class="upload-title">Drop your company list here</div>
      <div class="upload-sub">or click to browse</div>
      <div class="upload-types">
        <span class="type-tag">.xlsx</span>
        <span class="type-tag">.xls</span>
        <span class="type-tag">.csv</span>
      </div>
      <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" />
    </div>

    <div class="schema-hint">
      Required columns: <code>company_name</code> &nbsp;¬∑&nbsp; <code>website</code>
      &nbsp;‚Äî matches your <code>companies.xlsx</code> format exactly
    </div>

    <div class="file-preview" id="filePreview">
      <span style="font-size:1.2rem;">üìÑ</span>
      <span class="file-name" id="fileName">‚Äî</span>
      <span class="file-size" id="fileSize">‚Äî</span>
      <button class="file-remove" id="fileRemove">‚úï</button>
    </div>

    <div class="error-banner" id="errorBanner"></div>

    <button class="run-btn" id="runBtn" disabled>
      <span id="runBtnInner">‚ö° Run Intelligence Agent</span>
    </button>
  </div>

  <!-- ‚îÄ‚îÄ LIVE PROGRESS ‚îÄ‚îÄ -->
  <div class="progress-section" id="progressSection">
    <div class="progress-header">
      <div class="progress-title" id="progressTitle">Initializing agent‚Ä¶</div>
      <div class="progress-pct" id="progressPct">0%</div>
    </div>
    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progressBar"></div>
    </div>
    <div class="company-cards" id="companyCards"></div>
  </div>

  <!-- ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ -->
  <div class="results-section" id="resultsSection">

    <div class="results-header">
      <div class="results-title">Intelligence Report</div>
      <div class="badge" style="color:var(--accent2);border-color:rgba(6,214,160,0.3);background:rgba(6,214,160,0.08);">‚úì Complete</div>
    </div>

    <div class="stat-strip">
      <div class="stat-cell"><div class="stat-num" id="statCompanies">0</div><div class="stat-lbl">Companies</div></div>
      <div class="stat-cell"><div class="stat-num" id="statEmails">0</div><div class="stat-lbl">Emails Found</div></div>
      <div class="stat-cell"><div class="stat-num" id="statFounded">0</div><div class="stat-lbl">Founded Info</div></div>
      <div class="stat-cell"><div class="stat-num" id="statAbout">0</div><div class="stat-lbl">About Us</div></div>
    </div>

    <div class="table-wrap">
      <div class="table-header">
        <div class="table-live-dot" id="liveDot"></div>
        <div class="table-title">Extracted Data</div>
        <div class="table-count" id="tableCount">‚Äî</div>
      </div>
      <div style="overflow-x:auto;">
        <table class="data-table">
          <thead>
            <tr>
              <th>#</th>
              <th>Company</th>
              <th>Website</th>
              <th>Founded</th>
              <th>About Us</th>
              <th>Email</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>
    </div>

    <div class="download-bar" id="downloadBar" style="display:none;">
      <div>
        <div class="download-label">Report Ready</div>
        <div class="download-name">sales_intelligence_output.xlsx</div>
        <div class="download-meta" id="downloadMeta">‚Äî</div>
      </div>
      <a class="download-btn" id="downloadBtn" href="http://localhost:5000/download" target="_blank">
        ‚¨á Download Excel
      </a>
    </div>

  </div><!-- /results -->

</div><!-- /wrapper -->

<script>
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // CONFIG ‚Äî change this to match your server
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const API = 'http://localhost:5000';

  // ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ
  const dropZone     = document.getElementById('dropZone');
  const fileInput    = document.getElementById('fileInput');
  const filePreview  = document.getElementById('filePreview');
  const fileName     = document.getElementById('fileName');
  const fileSize     = document.getElementById('fileSize');
  const fileRemove   = document.getElementById('fileRemove');
  const runBtn       = document.getElementById('runBtn');
  const runBtnInner  = document.getElementById('runBtnInner');
  const errorBanner  = document.getElementById('errorBanner');

  const progressSection = document.getElementById('progressSection');
  const progressTitle   = document.getElementById('progressTitle');
  const progressPct     = document.getElementById('progressPct');
  const progressBar     = document.getElementById('progressBar');
  const companyCards    = document.getElementById('companyCards');

  const resultsSection  = document.getElementById('resultsSection');
  const tableBody       = document.getElementById('tableBody');
  const tableCount      = document.getElementById('tableCount');
  const downloadBar     = document.getElementById('downloadBar');
  const downloadMeta    = document.getElementById('downloadMeta');
  const liveDot         = document.getElementById('liveDot');

  let selectedFile = null;
  let cardMap = {}; // company_name ‚Üí card element

  // ‚îÄ‚îÄ Upload wiring ‚îÄ‚îÄ
  dropZone.addEventListener('click', () => fileInput.click());
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault(); dropZone.classList.remove('dragover');
    const f = e.dataTransfer.files[0]; if (f) handleFile(f);
  });
  fileInput.addEventListener('change', () => { if (fileInput.files[0]) handleFile(fileInput.files[0]); });

  function handleFile(f) {
    selectedFile = f;
    fileName.textContent = f.name;
    fileSize.textContent = formatSize(f.size);
    filePreview.classList.add('show');
    runBtn.disabled = false;
    hideError();
  }

  fileRemove.addEventListener('click', () => {
    selectedFile = null; fileInput.value = '';
    filePreview.classList.remove('show');
    runBtn.disabled = true;
    runBtnInner.innerHTML = '‚ö° Run Intelligence Agent';
  });

  function formatSize(b) {
    if (b < 1024) return b + ' B';
    if (b < 1024*1024) return (b/1024).toFixed(1) + ' KB';
    return (b/1024/1024).toFixed(1) + ' MB';
  }

  function showError(msg) { errorBanner.textContent = '‚ö† ' + msg; errorBanner.classList.add('show'); }
  function hideError() { errorBanner.classList.remove('show'); }

  // ‚îÄ‚îÄ Run ‚îÄ‚îÄ
  runBtn.addEventListener('click', async () => {
    if (!selectedFile) return;
    hideError();

    runBtn.disabled = true;
    runBtnInner.innerHTML = '<span class="spinner"></span> Uploading‚Ä¶';

    // Upload file
    const form = new FormData();
    form.append('file', selectedFile);

    let res;
    try {
      res = await fetch(`${API}/upload`, { method: 'POST', body: form });
    } catch(e) {
      showError('Cannot reach backend server at ' + API + '. Make sure server.py is running.');
      runBtn.disabled = false;
      runBtnInner.innerHTML = '‚ö° Run Intelligence Agent';
      return;
    }

    const data = await res.json();
    if (!res.ok) { showError(data.error || 'Upload failed.'); runBtn.disabled = false; runBtnInner.innerHTML = '‚ö° Run Intelligence Agent'; return; }

    runBtnInner.innerHTML = '<span class="spinner"></span> Agent Running‚Ä¶';

    // Show progress section, clear previous
    progressSection.classList.add('show');
    resultsSection.classList.remove('show');
    downloadBar.style.display = 'none';
    companyCards.innerHTML = '';
    tableBody.innerHTML = '';
    cardMap = {};

    // Start SSE
    listenToProgress();
  });

  // ‚îÄ‚îÄ SSE Progress ‚îÄ‚îÄ
  function listenToProgress() {
    const es = new EventSource(`${API}/progress`);

    es.onmessage = e => {
      let ev;
      try { ev = JSON.parse(e.data); } catch { return; }

      const { type, data } = ev;

      if (type === 'start') {
        progressTitle.textContent = `Processing ${data.total} companies‚Ä¶`;
        updateBar(0, data.total);
      }

      if (type === 'company_start') {
        progressTitle.textContent = `[${data.index}/${data.total}] ${data.company}`;
        updateBar(data.index - 1, data.total);
        addOrUpdateCard(data.company, data.website, 'active', 'Connecting‚Ä¶');
      }

      if (type === 'step') {
        updateCardStep(data.company, data.step);
      }

      if (type === 'company_done') {
        updateBar(data.index, data.total);
        finishCard(data.company, 'done');
        addTableRow(data.index, data.result);
        updateStats();
        // live pulse
        tableCount.textContent = `${data.index} of ${data.total} rows`;
      }

      if (type === 'done') {
        es.close();
        progressTitle.textContent = `‚úì Completed ${data.total} companies`;
        liveDot.style.animation = 'none';
        liveDot.style.background = 'var(--accent2)';
        downloadBar.style.display = 'flex';
        downloadMeta.textContent = `${data.total} companies ¬∑ Generated just now`;
        document.getElementById('downloadBtn').href = `${API}/download`;
        runBtnInner.innerHTML = '‚úì Analysis Complete';
        resultsSection.classList.add('show');
        updateStats();
      }

      if (type === 'error') {
        es.close();
        showError(data.message);
        runBtn.disabled = false;
        runBtnInner.innerHTML = '‚ö° Retry';
        progressSection.classList.remove('show');
      }
    };

    es.onerror = () => {
      // SSE ended normally after 'done' event
      es.close();
    };
  }

  function updateBar(current, total) {
    const pct = total > 0 ? Math.round((current / total) * 100) : 0;
    progressBar.style.width = pct + '%';
    progressPct.textContent = pct + '%';
  }

  function addOrUpdateCard(company, website, state, step) {
    if (cardMap[company]) {
      setCardState(cardMap[company], state, step);
      return;
    }
    const cc = document.createElement('div');
    cc.className = 'cc ' + state;
    cc.innerHTML = `
      <div class="cc-dot"></div>
      <div class="cc-name">${esc(company)}</div>
      <div class="cc-step" id="step-${slugify(company)}">${esc(step)}</div>
      <div class="cc-status">${state}</div>
    `;
    companyCards.appendChild(cc);
    cardMap[company] = cc;
    cc.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function updateCardStep(company, step) {
    const cc = cardMap[company];
    if (!cc) return;
    const stepEl = cc.querySelector('.cc-step');
    if (stepEl) stepEl.textContent = step;
  }

  function setCardState(cc, state, step) {
    cc.className = 'cc ' + state;
    const statusEl = cc.querySelector('.cc-status');
    if (statusEl) statusEl.textContent = state;
    if (step) updateCardStep(cc.querySelector('.cc-name')?.textContent, step);
  }

  function finishCard(company, state) {
    const cc = cardMap[company];
    if (!cc) return;
    cc.className = 'cc ' + state;
    const statusEl = cc.querySelector('.cc-status');
    if (statusEl) statusEl.textContent = state === 'done' ? '‚úì done' : 'error';
    const stepEl = cc.querySelector('.cc-step');
    if (stepEl) stepEl.textContent = state === 'done' ? 'Extraction complete' : 'Failed';
  }

  function addTableRow(idx, r) {
    const fields = (r['Founded Info'] ? 1 : 0) + (r['About Us'] ? 1 : 0) + (r['Email'] ? 1 : 0);
    const statusClass = fields === 3 ? 'status-ok' : fields > 0 ? 'status-partial' : 'status-empty';
    const statusLabel = fields === 3 ? 'Full' : fields > 0 ? 'Partial' : 'Empty';

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td style="color:var(--muted);font-size:0.7rem;">${idx}</td>
      <td class="td-company">${esc(r['Company Name'] || '‚Äî')}</td>
      <td><a class="td-link" href="${esc(r['Website']||'')}" target="_blank" rel="noopener">${shortURL(r['Website'])}</a></td>
      <td class="${r['Founded Info'] ? 'td-founded' : 'td-null'}">${esc(r['Founded Info'] || '‚Äî')}</td>
      <td style="font-size:0.7rem;max-width:220px;">${esc(truncate(r['About Us'] || '‚Äî', 120))}</td>
      <td class="${r['Email'] ? 'td-email' : 'td-null'}">${esc(r['Email'] || '‚Äî')}</td>
      <td><span class="status-badge ${statusClass}">${statusLabel}</span></td>
    `;
    tableBody.appendChild(tr);
    tr.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }

  function updateStats() {
    const rows = [...tableBody.querySelectorAll('tr')];
    document.getElementById('statCompanies').textContent = rows.length;
    document.getElementById('statEmails').textContent = rows.filter(r => !r.cells[5]?.classList.contains('td-null')).length;
    document.getElementById('statFounded').textContent = rows.filter(r => !r.cells[3]?.classList.contains('td-null')).length;
    document.getElementById('statAbout').textContent = rows.filter(r => r.cells[4]?.textContent !== '‚Äî').length;
  }

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
  function esc(s) {
    if (!s) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }
  function slugify(s) { return s.replace(/[^a-z0-9]/gi,'-').toLowerCase(); }
  function shortURL(u) {
    try { return new URL(u).hostname; } catch { return u || '‚Äî'; }
  }
  function truncate(s, n) { return s && s.length > n ? s.slice(0, n) + '‚Ä¶' : s; }
</script>

</body>
</html>
